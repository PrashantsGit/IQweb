{% extends "quizzes/base.html" %}
{% block title %}Question {{ question_num }} of {{ total_questions }}{% endblock %}

{% block extra_css %}
<style>
/* ------------------ VISUALS ------------------ */

/* Smooth fade transition */
.fade-question {
    opacity: 1;
    transform: translateY(0);
    transition: opacity .45s ease, transform .45s ease;
}
.fade-question.hide {
    opacity: 0;
    transform: translateY(20px);
}

/* Layout container */
.container-card {
    max-width: 900px;
    margin: 28px auto;
}

.panel {
    background: rgba(255,255,255,0.16);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 22px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.12);
}

/* Top row */
.top-row {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom: 14px;
}

.timer-badge {
    background: linear-gradient(135deg,#ff7a7a,#ffb86b);
    color:white;
    padding:8px 12px;
    border-radius:999px;
    font-weight:700;
}

/* Question */
.question-text {
    font-size:1.15rem;
    font-weight:600;
    margin-bottom:14px;
    color:#0b1220;
}

.question-image {
    width:100%;
    max-height:320px;
    object-fit:contain;
    border-radius:10px;
    background:#f8fafc;
    padding:10px;
    border:1px solid rgba(0,0,0,0.04);
    margin-bottom:16px;
}

/* Answer tiles */
.answers-grid {
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
}

.answer-tile {
    display:flex;
    gap:12px;
    align-items:center;
    padding:12px 14px;
    border-radius:12px;
    background:white;
    box-shadow:0 6px 18px rgba(2,6,23,0.06);
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease;
    border:2px solid transparent;
}

.answer-tile:hover {
    transform:translateY(-4px);
    box-shadow:0 12px 30px rgba(2,6,23,0.08);
}

.answer-tile.selected {
    border-color: rgba(37,117,252,0.4);
    box-shadow:0 14px 40px rgba(37,117,252,0.08);
}

.answer-tile input[type="radio"] {
    width:18px;
    height:18px;
    accent-color:#2575fc;
}

/* Buttons */
.actions {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:20px;
}

.btn-primary {
    background: linear-gradient(135deg,#6a11cb,#2575fc);
    color:white;
    border:none;
}

.btn-ghost {
    background:transparent;
    color:#2575fc;
    border:1px solid rgba(37,117,252,0.12);
    padding:8px 14px;
    border-radius:10px;
}

/* Mobile tweaks */
@media (max-width:720px) {
    .top-row { flex-direction:column; align-items:stretch; }
}
</style>
{% endblock %}


{% block content %}
<div class="container container-card">
    <div class="panel">

        <!-- Top row: timer + progress -->
        <div class="top-row">
            <div style="min-width:140px;">
                <div class="timer-badge">
                    ‚è± <span id="timer">{{ remaining_time }}</span>s
                </div>
            </div>

            <div class="progress-wrap flex-grow-1">
                <div class="d-flex justify-content-between mb-1">
                    <small>Question {{ question_num }} of {{ total_questions }}</small>
                    <small>{{ progress_percent }}% complete</small>
                </div>
                <div class="progress" style="height:10px; border-radius:9px;">
                    <div class="progress-bar" role="progressbar"
                         style="width: {{ progress_percent }}%;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Title -->
        <h4 class="mb-3" style="margin:0; color:#0b1220;">{{ attempt.test.title }}</h4>
        <hr>

        <!-- Question -->
        <div id="questionContainer" class="fade-question">

            <p class="question-text">{{ question.text }}</p>

            {% if question.image %}
                <img src="{{ question.image.url }}" class="question-image">
            {% endif %}

            <!-- FORM -->
            <form method="POST" id="answerForm">
                {% csrf_token %}

                <div class="answers-grid">

                    {% if question.question_type == 'MC' %}
                        {% for answer in answers %}
                        <label class="answer-tile">
                            <input type="radio" name="answer" value="{{ answer.id }}" required>
                            <div style="flex:1;">{{ answer.text }}</div>
                        </label>
                        {% endfor %}

                    {% elif question.question_type == 'LG' %}
                        <textarea name="text_input" class="form-control"
                                  rows="5" required></textarea>

                    {% endif %}
                </div>

                <div class="actions">
                    <a href="{% url 'test_list' %}" class="btn btn-ghost">Exit Test</a>
                    <button type="submit" id="submitBtn" class="btn btn-primary">
                        Submit & Continue
                    </button>
                </div>
            </form>

        </div>

    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
/* ------------------- TIMER ------------------- */
let timeLeft = parseInt("{{ remaining_time }}");
const timerEl = document.getElementById("timer");
const autoSubmitURL = "{% url 'test_submit' attempt_id=attempt.id %}";

function tick() {
    if (timeLeft <= 0) {
        window.location.href = autoSubmitURL;
        return;
    }
    timeLeft -= 1;
    timerEl.textContent = timeLeft;
}
setInterval(tick, 1000);


/* ------------------- ANSWER TILE UI ------------------- */
const tiles = document.querySelectorAll(".answer-tile");

function updateTiles() {
    tiles.forEach(t => {
        const r = t.querySelector("input[type='radio']");
        if (r.checked) t.classList.add("selected");
        else t.classList.remove("selected");
    });
}

tiles.forEach(tile => {
    const radio = tile.querySelector("input[type='radio']");
    tile.addEventListener("click", () => {
        radio.checked = true;
        updateTiles();
    });
    radio.addEventListener("change", updateTiles);
});
updateTiles();


/* ------------------- FADE ON SUBMIT ------------------- */
const form = document.getElementById("answerForm");
const qContainer = document.getElementById("questionContainer");

form.addEventListener("submit", function() {
    qContainer.classList.add("hide");  // smooth fade out
});
</script>
{% endblock %}
