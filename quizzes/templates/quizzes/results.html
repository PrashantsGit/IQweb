{% extends "quizzes/base.html" %}
{% block title %}Test Results - {{ attempt.test.title }}{% endblock %}

{% block extra_css %}
<style>

/* ================= GLASS CARD ================= */
.results-panel {
    background: rgba(255, 255, 255, 0.40); /* glass */
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    border-radius: 26px;
    padding: 45px 48px;
    border: 1px solid rgba(255,255,255,0.35);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
    color: #0f172a;  /* deep slate */
}

/* ================= HEADER ================= */
.results-panel h3 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 6px;
    color: #0f172a;
}

.small-muted {
    color: rgba(30, 41, 59, 0.65) !important; /* slate-600 */
    font-size: 0.95rem;
}

/* ================= SUMMARY LAYOUT ================= */
.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 34px;
    flex-wrap: wrap;
}

.summary-left { 
    flex: 1 1 380px;
}

.summary-right { 
    flex: 0 1 360px; 
    text-align: center; 
}

/* ================= STAT NUMBERS ================= */
.stat .num {
    font-size: 2.4rem;
    font-weight: 800;
    color: #0f172a;
}

/* ================= BOXES (Insights + Category) ================= */
.insight-box,
.cat-box {
    background: rgba(255, 255, 255, 0.55); /* light glass */
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-radius: 18px;
    padding: 22px 26px;
    box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
}

/* ================= CATEGORY TABLE ================= */
.table-cats th {
    background: rgba(37, 117, 252, 0.85);
    backdrop-filter: blur(4px);
    color: #fff;
    font-weight: 600;
}

.table-cats td {
    background: rgba(255,255,255,0.65);
    color: #0f172a;
}

/* Category IQ numbers */
.cat-iq {
    font-weight: 700;
    color: #0f172a;
}

/* ================= BUTTONS ================= */
.btn-primary {
    background: linear-gradient(135deg,#6a11cb,#2575fc) !important;
    border: none !important;
    color: white !important;
    padding: 11px 22px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 4px 14px rgba(37,117,252,0.25);
}

.btn-primary:hover {
    opacity: 0.92;
}

.btn-ghost {
    padding: 10px 20px;
    border-radius: 12px;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(37,117,252,0.20);
    color: #2563eb !important;
    font-weight: 600;
}

.btn-ghost:hover {
    background: rgba(255,255,255,0.95);
}

/* ================= GAUGE ================= */
.gauge-wrap {
    padding-top: 14px;
}

/* ================= RADAR CHART ================= */
.chart-box {
    max-width: 520px;
    margin: 12px auto 0;
    background: rgba(255,255,255,0.55);
    border-radius: 18px;
    padding: 20px;
    backdrop-filter: blur(12px);
    box-shadow: 0 10px 22px rgba(0,0,0,0.06);
}

/* ================= RESPONSIVE ================= */
@media (max-width: 880px) {
    .summary-row {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
    .summary-right {
        order: -1;
    }
}
</style>

{% endblock %}


{% block content %}
<div class="container-results">
  <div class="results-panel">

    <div class="summary-row">
      <!-- LEFT SIDE -->
      <div class="summary-left">
        <h3 class="mb-1">{{ attempt.test.title }}</h3>

        {% if attempt.is_completed %}
          <p class="small-muted">
            Completed on <strong>{{ attempt.end_time|date:"H:i:s, F j, Y" }}</strong>
          </p>
        {% endif %}

        <div class="mt-3">
          <div class="stat mb-2">
            <div class="num">{{ correct_count }}</div>
            <div>
              <div class="small-muted">Correct answers</div>
              <div class="small-muted">{{ total_questions }} questions total</div>
            </div>
          </div>

          <div class="stat">
            <div class="num">{{ score_percentage|floatformat:1 }}%</div>
            <div>
              <div class="small-muted">Final score</div>
              <div class="small-muted">Accuracy based</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE - GAUGE -->
      <div class="summary-right">
        <div class="gauge-wrap">

          <svg id="iqGauge" width="320" height="200" viewBox="0 0 320 200" aria-label="IQ gauge">
            <!-- gradients -->
            <defs>
              <linearGradient id="g1" x1="0" x2="1">
                <stop offset="0%" stop-color="#6a11cb"/>
                <stop offset="100%" stop-color="#2575fc"/>
              </linearGradient>
            </defs>

            <!-- background arc -->
            <path d="M20 170 A140 140 0 0 1 300 170"
                  fill="none"
                  stroke="rgba(255,255,255,0.08)"
                  stroke-width="26"
                  stroke-linecap="round"/>

            <!-- animated score arc -->
            <path id="gaugeArc"
                  d="M20 170 A140 140 0 0 1 300 170"
                  fill="none"
                  stroke="url(#g1)"
                  stroke-width="26"
                  stroke-linecap="round"
                  stroke-dasharray="0 1000"/>

            <!-- center circle -->
            <circle cx="160" cy="140" r="44" fill="rgba(0,0,0,0.25)"/>

            <text id="gaugeIQ"
                  x="160"
                  y="138"
                  text-anchor="middle"
                  font-size="20"
                  fill="#fff"
                  font-weight="700">
              {{ iq_score }}
            </text>

            <text x="160" y="158"
                  text-anchor="middle"
                  font-size="12"
                  fill="rgba(255,255,255,0.8)">
              Estimated IQ
            </text>

            <!-- TICKS REMOVED (no illegal .split() usage) -->

          </svg>

        </div>

        <div class="mt-2 small-muted">
          IQ Score (scaled): <strong>{{ iq_score }}</strong>
        </div>
      </div>
    </div>

    <hr style="border-color:rgba(255,255,255,0.06); margin:20px 0;">


    <!-- INSIGHTS & CATEGORY BREAKDOWN -->
    <div class="row g-4">

      <!-- Left: Performance -->
      <div class="col-md-6">
        <div class="p-3" style="background:rgba(255,255,255,0.05); border-radius:12px;">
          <h5>Performance Insights</h5>

          <p class="small-muted">
            {% if total_questions %}
              Accuracy: <strong>{{ score_percentage|floatformat:1 }}%</strong> â€”
              You got <strong>{{ correct_count }}</strong> out of <strong>{{ total_questions }}</strong>.
            {% else %}
              No scoring data available.
            {% endif %}
          </p>

          <ul class="small-muted">
            <li>Time taken: <strong>{{ attempt.end_time|default:"-" }}</strong></li>
            <li>Comparison to average: <strong>Above average</strong></li>
          </ul>

          <div class="actions" style="justify-content:flex-start; margin-top:12px;">
            <a href="{% url 'user_dashboard' %}" class="btn btn-primary">Dashboard</a>
            <a href="{% url 'test_start' attempt.test.pk %}" class="btn btn-ghost">Retake Test</a>
            <a href="{% url 'download_certificate' attempt_id=attempt.pk %}" class="btn btn-ghost">Download Certificate</a>
          </div>
        </div>
      </div>


      <!-- Right: Category Breakdown -->
      <div class="col-md-6">
        <div class="p-3" style="background:rgba(255,255,255,0.05); border-radius:12px;">
          <h5>Category Breakdown</h5>

          {% if category_results %}
          <div class="table-responsive mt-2">
            <table class="table table-sm table-cats">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Correct</th>
                  <th>Total</th>
                  <th>IQ</th>
                </tr>
              </thead>

              <tbody>
              {% for cat in category_results %}
                <tr>
                  <td>{{ cat.name }}</td>
                  <td>{{ cat.correct }}</td>
                  <td>{{ cat.total }}</td>
                  <td class="cat-iq">{{ cat.iq }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="chart-box mt-3">
            <canvas id="radarChart" height="220"></canvas>
          </div>

          {% else %}
            <p class="small-muted">No category data available.</p>
          {% endif %}
        </div>
      </div>

    </div>

  </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* -------------------- IQ Gauge Animation -------------------- */
(function() {
    const gaugeArc = document.getElementById('gaugeArc');
    const gaugeIQtext = document.getElementById('gaugeIQ');

    const targetIQ = parseFloat("{{ iq_score }}") || 100;
    const minIQ = 60;
    const maxIQ = 160;
    const clamped = Math.max(minIQ, Math.min(maxIQ, targetIQ));
    const ratio = (clamped - minIQ) / (maxIQ - minIQ);

    document.addEventListener("DOMContentLoaded", () => {
        const len = gaugeArc.getTotalLength();
        gaugeArc.style.strokeDasharray = "0 " + len;
        setTimeout(() => {
            gaugeArc.style.transition = "stroke-dasharray 1.2s ease-out";
            gaugeArc.style.strokeDasharray = (ratio * len) + " " + len;
        }, 200);

        // Center counter
        let start = minIQ;
        const end = clamped;
        const duration = 1100;
        let sTime = null;

        function animate(ts) {
            if (!sTime) sTime = ts;
            const progress = Math.min((ts - sTime) / duration, 1);
            const val = Math.round(start + (end - start) * progress);
            gaugeIQtext.textContent = val;
            if (progress < 1) requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);
    });
})();


/* -------------------- Radar Chart -------------------- */
{% if category_results %}
const ctx = document.getElementById('radarChart').getContext('2d');

new Chart(ctx, {
    type: 'radar',
    data: {
        labels: [{% for c in category_results %}'{{ c.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: "Category IQ",
            data: [{% for c in category_results %}{{ c.iq }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            fill: true,
            backgroundColor: "rgba(37,117,252,0.18)",
            borderColor: "#2575fc",
            pointBackgroundColor: "#2575fc",
        }]
    },
    options: {
        scales: {
            r: {
                min: 60,
                max: 160,
                ticks: { stepSize: 20 }
            }
        },
        plugins: { legend: { display: false } }
    }
});
{% endif %}
</script>
{% endblock %}
